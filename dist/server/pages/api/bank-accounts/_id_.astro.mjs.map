{"version":3,"file":"_id_.astro.mjs","sources":["../../../../../src/pages/api/bank-accounts/[id].ts"],"sourcesContent":["import type { APIRoute } from \"astro\";\nimport { getSession } from \"../../../lib/get-session-astro\";\nimport { prisma } from \"../../../lib/db\";\nimport { apiResponse, apiError } from \"../../../lib/api-utils\";\n\nconst VALID_BANK_TYPES = [\n  \"NAVY_FEDERAL\",\n  \"PNC\",\n  \"CAPITAL_ONE\",\n  \"TRUIST\",\n  \"CHASE\",\n  \"BANK_OF_AMERICA\",\n  \"WELLS_FARGO\",\n  \"OTHER\",\n] as const;\n\nexport const GET: APIRoute = async ({ request, params }) => {\n  const session = await getSession(request);\n  if (!session?.user?.id) {\n    return apiError(\"Unauthorized\", 401);\n  }\n\n  const { id } = params;\n  if (!id) {\n    return apiError(\"Account ID required\", 400);\n  }\n\n  const account = await prisma.bankAccount.findFirst({\n    where: { id, userId: session.user.id },\n  });\n\n  if (!account) {\n    return apiError(\"Bank account not found\", 404);\n  }\n\n  return apiResponse(account);\n};\n\nexport const PATCH: APIRoute = async ({ request, params }) => {\n  const session = await getSession(request);\n  if (!session?.user?.id) {\n    return apiError(\"Unauthorized\", 401);\n  }\n\n  const { id } = params;\n  if (!id) {\n    return apiError(\"Account ID required\", 400);\n  }\n\n  try {\n    const body = await request.json();\n\n    const existing = await prisma.bankAccount.findFirst({\n      where: { id, userId: session.user.id },\n    });\n\n    if (!existing) {\n      return apiError(\"Bank account not found\", 404);\n    }\n\n    if (body.bank && !VALID_BANK_TYPES.includes(body.bank)) {\n      return apiError(`bank must be one of: ${VALID_BANK_TYPES.join(\", \")}`, 400);\n    }\n\n    const isDefault = body.isDefault === true;\n\n    if (isDefault && !existing.isDefault) {\n      await prisma.bankAccount.updateMany({\n        where: { userId: session.user.id, isDefault: true },\n        data: { isDefault: false },\n      });\n    }\n\n    const account = await prisma.bankAccount.update({\n      where: { id },\n      data: {\n        name: body.name ?? existing.name,\n        bank: body.bank ?? existing.bank,\n        lastFour: body.lastFour !== undefined ? body.lastFour : existing.lastFour,\n        isDefault: body.isDefault !== undefined ? isDefault : existing.isDefault,\n      },\n    });\n\n    return apiResponse(account);\n  } catch (error) {\n    return apiError(error instanceof Error ? error.message : \"Failed to update bank account\", 400);\n  }\n};\n\nexport const DELETE: APIRoute = async ({ request, params }) => {\n  const session = await getSession(request);\n  if (!session?.user?.id) {\n    return apiError(\"Unauthorized\", 401);\n  }\n\n  const { id } = params;\n  if (!id) {\n    return apiError(\"Account ID required\", 400);\n  }\n\n  try {\n    const existing = await prisma.bankAccount.findFirst({\n      where: { id, userId: session.user.id },\n    });\n\n    if (!existing) {\n      return apiError(\"Bank account not found\", 404);\n    }\n\n    await prisma.bill.updateMany({\n      where: { bankAccountId: id },\n      data: { bankAccountId: null },\n    });\n\n    await prisma.debt.updateMany({\n      where: { bankAccountId: id },\n      data: { bankAccountId: null },\n    });\n\n    await prisma.bankAccount.delete({\n      where: { id },\n    });\n\n    return apiResponse({ success: true });\n  } catch (error) {\n    return apiError(error instanceof Error ? error.message : \"Failed to delete bank account\", 400);\n  }\n};\n"],"names":[],"mappings":"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"}