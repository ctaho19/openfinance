{"version":3,"file":"paycheck-plan.astro.mjs","sources":["../../../../src/pages/api/paycheck-plan/index.ts"],"sourcesContent":["import type { APIRoute } from \"astro\";\nimport { getSession } from \"../../../lib/get-session-astro\";\nimport { getDollarAllocationPlan, setupUserStrategy } from \"../../../lib/services/dollar-allocation-plan\";\nimport { apiResponse, apiError } from \"../../../lib/api-utils\";\n\nexport const GET: APIRoute = async ({ request }) => {\n  const session = await getSession(request);\n  if (!session?.user?.id) {\n    return apiError(\"Unauthorized\", 401);\n  }\n\n  try {\n    const plan = await getDollarAllocationPlan(session.user.id);\n    \n    const serializedPlan = {\n      ...plan,\n      period: {\n        startDate: plan.period.startDate.toISOString(),\n        endDate: plan.period.endDate.toISOString(),\n        paycheckDate: plan.period.paycheckDate.toISOString(),\n      },\n      steps: plan.steps.map((s) => ({\n        ...s,\n        dueDate: s.dueDate?.toISOString(),\n      })),\n      transfers: plan.transfers.map((s) => ({\n        ...s,\n        dueDate: s.dueDate?.toISOString(),\n      })),\n      billPayments: plan.billPayments.map((s) => ({\n        ...s,\n        dueDate: s.dueDate?.toISOString(),\n      })),\n      extraDebtStep: plan.extraDebtStep\n        ? { ...plan.extraDebtStep, dueDate: plan.extraDebtStep.dueDate?.toISOString() }\n        : undefined,\n      savingsStep: plan.savingsStep\n        ? { ...plan.savingsStep, dueDate: plan.savingsStep.dueDate?.toISOString() }\n        : undefined,\n      payoffProgress: {\n        ...plan.payoffProgress,\n        startDate: plan.payoffProgress.startDate?.toISOString(),\n        targetDate: plan.payoffProgress.targetDate?.toISOString(),\n      },\n      unpaidPayments: plan.unpaidPayments.map((p) => ({\n        ...p,\n        dueDate: p.dueDate.toISOString(),\n        paidAt: p.paidAt?.toISOString(),\n        createdAt: p.createdAt.toISOString(),\n        updatedAt: p.updatedAt.toISOString(),\n        bill: {\n          ...p.bill,\n          createdAt: p.bill.createdAt.toISOString(),\n          updatedAt: p.bill.updatedAt.toISOString(),\n        },\n      })),\n    };\n\n    return apiResponse(serializedPlan);\n  } catch (error) {\n    console.error(\"Error getting paycheck plan:\", error);\n    return apiError(\n      error instanceof Error ? error.message : \"Failed to get paycheck plan\",\n      500\n    );\n  }\n};\n\nexport const PUT: APIRoute = async ({ request }) => {\n  const session = await getSession(request);\n  if (!session?.user?.id) {\n    return apiError(\"Unauthorized\", 401);\n  }\n\n  try {\n    const body = await request.json();\n    \n    await setupUserStrategy(session.user.id, {\n      paycheckBankAccountId: body.paycheckBankAccountId,\n      spendingBankAccountId: body.spendingBankAccountId,\n      discretionaryBudgetMonthly: body.discretionaryBudgetMonthly,\n      emergencyFundTarget: body.emergencyFundTarget,\n      debtSurplusPercent: body.debtSurplusPercent,\n      savingsSurplusPercent: body.savingsSurplusPercent,\n      payoffStartDate: body.payoffStartDate ? new Date(body.payoffStartDate) : undefined,\n      payoffStartTotalDebt: body.payoffStartTotalDebt,\n      payoffTargetDate: body.payoffTargetDate ? new Date(body.payoffTargetDate) : undefined,\n    });\n\n    return apiResponse({ success: true });\n  } catch (error) {\n    console.error(\"Error updating strategy:\", error);\n    return apiError(\n      error instanceof Error ? error.message : \"Failed to update strategy\",\n      400\n    );\n  }\n};\n"],"names":[],"mappings":"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"}