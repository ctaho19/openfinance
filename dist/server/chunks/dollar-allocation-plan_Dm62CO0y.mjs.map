{"version":3,"file":"dollar-allocation-plan_Dm62CO0y.mjs","sources":["../../../src/lib/services/dollar-allocation-plan.ts"],"sourcesContent":["import { prisma } from \"@/lib/db\";\nimport { getCurrentPayPeriod, type PayPeriod } from \"@/lib/pay-periods\";\nimport { getPaymentsForPeriod, type PaymentWithBill } from \"./pay-periods\";\nimport { listDebts, type SerializedDebt } from \"./debts\";\nimport { format } from \"date-fns\";\nimport type { BankAccount, SavingsGoal } from \"@prisma/client\";\n\nexport type PlanStepType =\n  | \"TRANSFER\"\n  | \"BILL_PAYMENT\"\n  | \"EXTRA_DEBT_PAYMENT\"\n  | \"SAVINGS_TRANSFER\";\n\nexport interface PlanStep {\n  id: string;\n  type: PlanStepType;\n  order: number;\n  label: string;\n  amount: number;\n  fromAccountId?: string;\n  fromAccountName?: string;\n  toAccountId?: string;\n  toAccountName?: string;\n  billPaymentId?: string;\n  debtId?: string;\n  savingsGoalId?: string;\n  dueDate?: Date;\n  purpose?: string;\n}\n\nexport interface SurplusSplit {\n  surplus: number;\n  savingsAllocation: number;\n  debtAllocation: number;\n  isNegative: boolean;\n}\n\nexport interface AvalancheTarget {\n  debtId: string;\n  debtName: string;\n  bankAccountId: string | null;\n  bankAccountName: string | null;\n  interestRate: number;\n  currentBalance: number;\n}\n\nexport interface PayoffProgress {\n  startDate?: Date;\n  targetDate?: Date;\n  startDebt?: number;\n  currentDebt: number;\n  debtPaid?: number;\n  debtAdded?: number;\n  adjustedStartDebt?: number;\n  debtProgressPct?: number;\n  timeProgressPct?: number;\n  onTrack?: boolean;\n  monthsRemaining?: number;\n  baselineStale?: boolean;\n}\n\nexport interface BankAccountSummary {\n  id: string;\n  name: string;\n  bank: string;\n  requiredAmount: number;\n  purpose: string[];\n}\n\nexport interface DollarAllocationPlan {\n  period: PayPeriod;\n  paycheckAmount: number;\n  totalBillsThisPeriod: number;      // All bills for period (paid + unpaid)\n  billsRemainingThisPeriod: number;  // Only unpaid bills\n  billsPaidThisPeriod: number;       // Already paid\n  discretionaryThisPaycheck: number;\n  surplusSplit: SurplusSplit;\n  avalancheTarget?: AvalancheTarget;\n  steps: PlanStep[];\n  transfers: PlanStep[];\n  billPayments: PlanStep[];\n  extraDebtStep?: PlanStep;\n  savingsStep?: PlanStep;\n  payoffProgress: PayoffProgress;\n  bankAccountSummaries: BankAccountSummary[];\n  emergencyFundCurrent: number;\n  emergencyFundTarget: number;\n  unpaidPayments: PaymentWithBill[];\n  debtSurplusPercent: number;\n  savingsSurplusPercent: number;\n}\n\nfunction checksPerYear(freq: string): number {\n  switch (freq) {\n    case \"weekly\":\n      return 52;\n    case \"biweekly\":\n      return 26;\n    case \"monthly\":\n      return 12;\n    default:\n      return 26;\n  }\n}\n\nfunction getDiscretionaryPerPaycheck(\n  discretionaryMonthly: number | null | undefined,\n  paycheckFrequency: string\n): number {\n  if (!discretionaryMonthly || discretionaryMonthly <= 0) return 0;\n  const paychecksPerYear = checksPerYear(paycheckFrequency);\n  return (discretionaryMonthly * 12) / paychecksPerYear;\n}\n\nfunction computeSurplusSplit(params: {\n  paycheckAmount: number;\n  billsDueThisPeriod: number;\n  discretionary: number;\n  emergencyFundTarget: number;\n  currentEmergencyAmount: number;\n  debtSurplusPercent: number;\n  savingsSurplusPercent: number;\n}): SurplusSplit {\n  const { paycheckAmount, billsDueThisPeriod, discretionary } = params;\n  const baseNeeds = billsDueThisPeriod + discretionary;\n  const surplusRaw = paycheckAmount - baseNeeds;\n\n  if (surplusRaw <= 0) {\n    return {\n      surplus: surplusRaw,\n      savingsAllocation: 0,\n      debtAllocation: 0,\n      isNegative: true,\n    };\n  }\n\n  const efRemaining = Math.max(\n    0,\n    params.emergencyFundTarget - params.currentEmergencyAmount\n  );\n\n  let savingsAllocation = 0;\n  if (efRemaining > 0) {\n    savingsAllocation = Math.min(\n      surplusRaw * params.savingsSurplusPercent,\n      efRemaining\n    );\n  }\n\n  const debtAllocation = surplusRaw - savingsAllocation;\n  return {\n    surplus: surplusRaw,\n    savingsAllocation,\n    debtAllocation,\n    isNegative: false,\n  };\n}\n\nfunction findAvalancheTarget(\n  debts: SerializedDebt[],\n  bankAccounts: BankAccount[]\n): AvalancheTarget | undefined {\n  const candidates = debts.filter(\n    (d) =>\n      d.isActive &&\n      d.currentBalance > 0 &&\n      d.status !== \"PAID_OFF\" &&\n      d.status !== \"DEFERRED\"\n  );\n\n  if (!candidates.length) return undefined;\n\n  candidates.sort((a, b) => {\n    const aRate = Math.max(a.effectiveRate ?? 0, a.interestRate ?? 0);\n    const bRate = Math.max(b.effectiveRate ?? 0, b.interestRate ?? 0);\n    return bRate - aRate;\n  });\n\n  const top = candidates[0];\n  const bankAccount = bankAccounts.find((ba) => ba.id === top.bankAccountId);\n\n  return {\n    debtId: top.id,\n    debtName: top.name,\n    bankAccountId: top.bankAccountId,\n    bankAccountName: bankAccount?.name ?? null,\n    interestRate: Math.max(top.effectiveRate ?? 0, top.interestRate),\n    currentBalance: top.currentBalance,\n  };\n}\n\nfunction computePayoffProgress(\n  user: {\n    payoffStartDate?: Date | null;\n    payoffStartTotalDebt?: number | null;\n    payoffTargetDate?: Date | null;\n  },\n  currentDebt: number\n): PayoffProgress {\n  const { payoffStartDate, payoffStartTotalDebt, payoffTargetDate } = user;\n\n  if (!payoffStartDate || !payoffStartTotalDebt || !payoffTargetDate) {\n    return { currentDebt };\n  }\n\n  const now = new Date();\n\n  const debtPaid = Math.max(0, payoffStartTotalDebt - currentDebt);\n  const debtAdded = Math.max(0, currentDebt - payoffStartTotalDebt);\n\n  const adjustedStartDebt = payoffStartTotalDebt + debtAdded;\n  const baselineStale = debtAdded > 0;\n\n  const debtProgressPct =\n    adjustedStartDebt > 0\n      ? Math.max(0, Math.min(1, debtPaid / adjustedStartDebt))\n      : 0;\n\n  const totalMs = payoffTargetDate.getTime() - payoffStartDate.getTime();\n  const elapsedMs = now.getTime() - payoffStartDate.getTime();\n  const timeProgressPct =\n    totalMs > 0 ? Math.max(0, Math.min(1, elapsedMs / totalMs)) : undefined;\n\n  const remainingMs = Math.max(0, payoffTargetDate.getTime() - now.getTime());\n  const monthsRemaining = Math.ceil(remainingMs / (30 * 24 * 60 * 60 * 1000));\n\n  const onTrack =\n    timeProgressPct !== undefined ? debtProgressPct >= timeProgressPct : undefined;\n\n  return {\n    startDate: payoffStartDate,\n    targetDate: payoffTargetDate,\n    startDebt: payoffStartTotalDebt,\n    currentDebt,\n    debtPaid,\n    debtAdded,\n    adjustedStartDebt,\n    debtProgressPct,\n    timeProgressPct,\n    onTrack,\n    monthsRemaining,\n    baselineStale,\n  };\n}\n\nexport async function getDollarAllocationPlan(\n  userId: string,\n  forDate: Date = new Date()\n): Promise<DollarAllocationPlan> {\n  const period = getCurrentPayPeriod();\n\n  const [user, payments, debts, bankAccounts, savingsGoals, pastDuePayments] = await Promise.all([\n    prisma.user.findUnique({\n      where: { id: userId },\n      select: {\n        paycheckAmount: true,\n        paycheckFrequency: true,\n        paycheckBankAccountId: true,\n        spendingBankAccountId: true,\n        discretionaryBudgetMonthly: true,\n        emergencyFundTarget: true,\n        debtSurplusPercent: true,\n        savingsSurplusPercent: true,\n        payoffStartDate: true,\n        payoffStartTotalDebt: true,\n        payoffTargetDate: true,\n      },\n    }),\n    getPaymentsForPeriod(userId, period.startDate, period.endDate),\n    listDebts(userId, \"effective\"),\n    prisma.bankAccount.findMany({ where: { userId } }),\n    prisma.savingsGoal.findMany({ where: { userId } }),\n    prisma.billPayment.findMany({\n      where: {\n        bill: { userId },\n        dueDate: { lt: period.startDate },\n        status: \"UNPAID\",\n      },\n      include: {\n        bill: {\n          include: {\n            debt: { select: { id: true, name: true, type: true, status: true } },\n          },\n        },\n      },\n      orderBy: { dueDate: \"asc\" },\n    }),\n  ]);\n\n  if (!user) {\n    throw new Error(\"User not found\");\n  }\n\n  const unpaidPayments = payments.filter((p) => p.status === \"UNPAID\");\n  const paidPayments = payments.filter((p) => p.status === \"PAID\");\n\n  // Total bills for the period (both paid and unpaid) - used for surplus calculation\n  const totalBillsThisPeriod = payments.reduce(\n    (sum, p) => sum + Number(p.amount),\n    0\n  );\n\n  // Only unpaid bills remaining - shown in UI for \"bills remaining\"\n  const billsRemainingThisPeriod = unpaidPayments.reduce(\n    (sum, p) => sum + Number(p.amount),\n    0\n  );\n\n  // Already paid this period\n  const billsPaidThisPeriod = paidPayments.reduce(\n    (sum, p) => sum + Number(p.amount),\n    0\n  );\n\n  const billsByAccount: Record<string, number> = {};\n  for (const p of unpaidPayments) {\n    const accountId = p.bill.bankAccountId ?? user.paycheckBankAccountId ?? \"UNKNOWN\";\n    billsByAccount[accountId] = (billsByAccount[accountId] ?? 0) + Number(p.amount);\n  }\n\n  const paycheckAmount = Number(user.paycheckAmount ?? 0);\n  const discretionaryMonthly = Number(user.discretionaryBudgetMonthly ?? 750);\n  const discretionary = getDiscretionaryPerPaycheck(\n    discretionaryMonthly,\n    user.paycheckFrequency\n  );\n\n  const emergencyGoal = savingsGoals.find(\n    (g) =>\n      g.fooStep === \"EMERGENCY_FUND\" ||\n      g.name.toLowerCase().includes(\"emergency\")\n  );\n  const currentEmergencyAmount = emergencyGoal\n    ? Number(emergencyGoal.currentAmount)\n    : 0;\n  const emergencyFundTarget = Number(user.emergencyFundTarget ?? 1000);\n\n  const debtSurplusPercent = Number(user.debtSurplusPercent ?? 0.8);\n  const savingsSurplusPercent = Number(user.savingsSurplusPercent ?? 0.2);\n\n  // Use TOTAL bills (not just unpaid) for surplus calculation\n  // This gives the TRUE surplus for the pay period\n  const surplusSplit = computeSurplusSplit({\n    paycheckAmount,\n    billsDueThisPeriod: totalBillsThisPeriod,\n    discretionary,\n    emergencyFundTarget,\n    currentEmergencyAmount,\n    debtSurplusPercent,\n    savingsSurplusPercent,\n  });\n\n  const serializedDebts = await Promise.all(\n    debts.map(async (d) => {\n      const debt = await prisma.debt.findUnique({\n        where: { id: d.id },\n        include: { payments: { orderBy: { date: \"desc\" } } },\n      });\n      if (!debt) return null;\n      return {\n        id: debt.id,\n        userId: debt.userId,\n        name: debt.name,\n        type: debt.type,\n        status: debt.status,\n        currentBalance: Number(debt.currentBalance),\n        originalBalance: Number(debt.originalBalance),\n        interestRate: Number(debt.interestRate),\n        effectiveRate: debt.effectiveRate ? Number(debt.effectiveRate) : null,\n        totalRepayable: debt.totalRepayable ? Number(debt.totalRepayable) : null,\n        minimumPayment: Number(debt.minimumPayment),\n        pastDueAmount: debt.pastDueAmount ? Number(debt.pastDueAmount) : null,\n        dueDay: debt.dueDay,\n        paymentFrequency: debt.paymentFrequency,\n        startDate: debt.startDate.toISOString(),\n        deferredUntil: debt.deferredUntil ? debt.deferredUntil.toISOString() : null,\n        bankAccountId: debt.bankAccountId,\n        isActive: debt.isActive,\n        notes: debt.notes,\n        createdAt: debt.createdAt.toISOString(),\n        updatedAt: debt.updatedAt.toISOString(),\n        payments: debt.payments.map((p) => ({\n          id: p.id,\n          debtId: p.debtId,\n          date: p.date.toISOString(),\n          amount: Number(p.amount),\n          principal: Number(p.principal),\n          interest: Number(p.interest),\n          newBalance: Number(p.newBalance),\n          notes: p.notes,\n          createdAt: p.createdAt.toISOString(),\n        })),\n      };\n    })\n  );\n\n  const validDebts = serializedDebts.filter((d): d is SerializedDebt => d !== null);\n\n  const avalancheTarget = findAvalancheTarget(validDebts, bankAccounts);\n\n  const totalDebt = validDebts\n    .filter((d) => d.isActive)\n    .reduce((sum, d) => sum + d.currentBalance, 0);\n\n  const payoffProgress = computePayoffProgress(\n    {\n      payoffStartDate: user.payoffStartDate,\n      payoffStartTotalDebt: user.payoffStartTotalDebt\n        ? Number(user.payoffStartTotalDebt)\n        : null,\n      payoffTargetDate: user.payoffTargetDate,\n    },\n    totalDebt\n  );\n\n  const steps: PlanStep[] = [];\n  const transfers: PlanStep[] = [];\n  const billPayments: PlanStep[] = [];\n  let extraDebtStep: PlanStep | undefined;\n  let savingsStep: PlanStep | undefined;\n\n  const paycheckAccount = bankAccounts.find(\n    (ba) => ba.id === user.paycheckBankAccountId\n  );\n  const spendingAccount = bankAccounts.find(\n    (ba) => ba.id === user.spendingBankAccountId\n  );\n  const paycheckAccountName = paycheckAccount?.name ?? \"Income Account\";\n\n  const requiredFunding: Record<string, { amount: number; purposes: string[] }> = {};\n\n  for (const [accountId, amt] of Object.entries(billsByAccount)) {\n    if (accountId !== user.paycheckBankAccountId && accountId !== \"UNKNOWN\") {\n      if (!requiredFunding[accountId]) {\n        requiredFunding[accountId] = { amount: 0, purposes: [] };\n      }\n      requiredFunding[accountId].amount += amt;\n      requiredFunding[accountId].purposes.push(\"Bills\");\n    }\n  }\n\n  if (discretionary > 0 && user.spendingBankAccountId && user.spendingBankAccountId !== user.paycheckBankAccountId) {\n    if (!requiredFunding[user.spendingBankAccountId]) {\n      requiredFunding[user.spendingBankAccountId] = { amount: 0, purposes: [] };\n    }\n    requiredFunding[user.spendingBankAccountId].amount += discretionary;\n    requiredFunding[user.spendingBankAccountId].purposes.push(\"Spending\");\n  }\n\n  if (\n    surplusSplit.debtAllocation > 0 &&\n    avalancheTarget?.bankAccountId &&\n    avalancheTarget.bankAccountId !== user.paycheckBankAccountId\n  ) {\n    if (!requiredFunding[avalancheTarget.bankAccountId]) {\n      requiredFunding[avalancheTarget.bankAccountId] = { amount: 0, purposes: [] };\n    }\n    requiredFunding[avalancheTarget.bankAccountId].amount += surplusSplit.debtAllocation;\n    requiredFunding[avalancheTarget.bankAccountId].purposes.push(\"Extra Debt Payment\");\n  }\n\n  let transferOrder = 100;\n  for (const [accountId, { amount, purposes }] of Object.entries(requiredFunding)) {\n    const targetAccount = bankAccounts.find((ba) => ba.id === accountId);\n    const targetName = targetAccount?.name ?? \"Account\";\n    const purposeStr = purposes.join(\" & \");\n\n    const transferStep: PlanStep = {\n      id: `transfer-${accountId}`,\n      type: \"TRANSFER\",\n      order: transferOrder++,\n      label: `Transfer $${amount.toFixed(2)} from ${paycheckAccountName} to ${targetName} for ${purposeStr}`,\n      amount,\n      fromAccountId: user.paycheckBankAccountId ?? undefined,\n      fromAccountName: paycheckAccountName,\n      toAccountId: accountId,\n      toAccountName: targetName,\n      purpose: purposeStr,\n    };\n\n    transfers.push(transferStep);\n    steps.push(transferStep);\n  }\n\n  let paymentOrder = 200;\n  for (const payment of unpaidPayments) {\n    const dueDate = new Date(payment.dueDate);\n    const paymentAccount = bankAccounts.find(\n      (ba) => ba.id === payment.bill.bankAccountId\n    );\n    const accountNote = paymentAccount ? ` (from ${paymentAccount.name})` : \"\";\n\n    const billStep: PlanStep = {\n      id: payment.id,\n      type: \"BILL_PAYMENT\",\n      order: paymentOrder++,\n      label: `${format(dueDate, \"MMM d\")} — ${payment.bill.name} — $${Number(payment.amount).toFixed(2)}${accountNote}`,\n      amount: Number(payment.amount),\n      billPaymentId: payment.id,\n      dueDate,\n    };\n\n    billPayments.push(billStep);\n    steps.push(billStep);\n  }\n\n  if (surplusSplit.debtAllocation > 0 && avalancheTarget) {\n    extraDebtStep = {\n      id: \"extra-debt\",\n      type: \"EXTRA_DEBT_PAYMENT\",\n      order: 300,\n      label: `Send $${surplusSplit.debtAllocation.toFixed(2)} extra to ${avalancheTarget.debtName} (${avalancheTarget.interestRate.toFixed(2)}% APR)`,\n      amount: surplusSplit.debtAllocation,\n      debtId: avalancheTarget.debtId,\n    };\n    steps.push(extraDebtStep);\n  }\n\n  if (surplusSplit.savingsAllocation > 0) {\n    savingsStep = {\n      id: \"savings-ef\",\n      type: \"SAVINGS_TRANSFER\",\n      order: 350,\n      label: `Move $${surplusSplit.savingsAllocation.toFixed(2)} to Emergency Fund`,\n      amount: surplusSplit.savingsAllocation,\n      savingsGoalId: emergencyGoal?.id,\n    };\n    steps.push(savingsStep);\n  }\n\n  steps.sort((a, b) => a.order - b.order);\n\n  const bankAccountSummaries: BankAccountSummary[] = Object.entries(requiredFunding).map(\n    ([accountId, { amount, purposes }]) => {\n      const account = bankAccounts.find((ba) => ba.id === accountId);\n      return {\n        id: accountId,\n        name: account?.name ?? \"Unknown\",\n        bank: account?.bank ?? \"OTHER\",\n        requiredAmount: amount,\n        purpose: purposes,\n      };\n    }\n  );\n\n  return {\n    period,\n    paycheckAmount,\n    totalBillsThisPeriod,\n    billsRemainingThisPeriod,\n    billsPaidThisPeriod,\n    discretionaryThisPaycheck: discretionary,\n    surplusSplit,\n    avalancheTarget,\n    steps,\n    transfers,\n    billPayments,\n    extraDebtStep,\n    savingsStep,\n    payoffProgress,\n    bankAccountSummaries,\n    emergencyFundCurrent: currentEmergencyAmount,\n    emergencyFundTarget,\n    unpaidPayments: pastDuePayments as PaymentWithBill[],\n    debtSurplusPercent,\n    savingsSurplusPercent,\n  };\n}\n\nexport async function recordExtraDebtPayment(\n  userId: string,\n  debtId: string,\n  amount: number\n): Promise<{ success: boolean; newBalance: number }> {\n  const debt = await prisma.debt.findFirst({\n    where: { id: debtId, userId },\n  });\n\n  if (!debt) {\n    throw new Error(\"Debt not found\");\n  }\n\n  const currentBalance = Number(debt.currentBalance);\n  const interestRate = Number(debt.interestRate);\n\n  let interest = 0;\n  let principal = amount;\n\n  if (debt.type !== \"BNPL\" && interestRate > 0) {\n    const monthlyRate = interestRate / 100 / 12;\n    interest = Math.min(currentBalance * monthlyRate, amount);\n    principal = amount - interest;\n  }\n\n  const newBalance = Math.max(0, currentBalance - principal);\n\n  await prisma.$transaction([\n    prisma.debtPayment.create({\n      data: {\n        debtId,\n        date: new Date(),\n        amount,\n        principal,\n        interest,\n        newBalance,\n        notes: \"Extra payment from Dollar Allocation Plan\",\n      },\n    }),\n    prisma.debt.update({\n      where: { id: debtId },\n      data: { currentBalance: newBalance },\n    }),\n    prisma.quickPayment.create({\n      data: {\n        userId,\n        description: `Extra payment to ${debt.name}`,\n        amount,\n        paidAt: new Date(),\n        debtId,\n        category: \"DEBT_SURPLUS\",\n        notes: \"Extra payment from Dollar Allocation Plan (avalanche method)\",\n      },\n    }),\n  ]);\n\n  if (debt.type === \"BNPL\") {\n    const nextScheduled = await prisma.scheduledPayment.findFirst({\n      where: {\n        debtId,\n        isPaid: false,\n        dueDate: { gte: new Date() },\n      },\n      orderBy: { dueDate: \"asc\" },\n    });\n\n    if (nextScheduled && amount >= Number(nextScheduled.amount)) {\n      await prisma.scheduledPayment.update({\n        where: { id: nextScheduled.id },\n        data: {\n          isPaid: true,\n          paidAt: new Date(),\n          paidAmount: amount,\n          notes:\n            (nextScheduled.notes || \"\") + \" (Paid via extra avalanche payment)\",\n        },\n      });\n\n      const bill = await prisma.bill.findFirst({\n        where: { debtId, isActive: true },\n        include: {\n          payments: {\n            where: { status: \"UNPAID\" },\n            orderBy: { dueDate: \"asc\" },\n            take: 1,\n          },\n        },\n      });\n\n      if (bill?.payments[0]) {\n        await prisma.billPayment.update({\n          where: { id: bill.payments[0].id },\n          data: { status: \"PAID\", paidAt: new Date() },\n        });\n      }\n    }\n  }\n\n  return { success: true, newBalance };\n}\n\nexport async function updateEmergencyFund(\n  userId: string,\n  amount: number\n): Promise<{ success: boolean; newAmount: number }> {\n  const savingsGoals = await prisma.savingsGoal.findMany({\n    where: { userId },\n  });\n\n  let emergencyGoal = savingsGoals.find(\n    (g) =>\n      g.fooStep === \"EMERGENCY_FUND\" ||\n      g.name.toLowerCase().includes(\"emergency\")\n  );\n\n  if (!emergencyGoal) {\n    emergencyGoal = await prisma.savingsGoal.create({\n      data: {\n        userId,\n        name: \"Emergency Fund\",\n        targetAmount: 1000,\n        currentAmount: amount,\n        fooStep: \"EMERGENCY_FUND\",\n      },\n    });\n    return { success: true, newAmount: amount };\n  }\n\n  const newAmount = Number(emergencyGoal.currentAmount) + amount;\n\n  await prisma.savingsGoal.update({\n    where: { id: emergencyGoal.id },\n    data: { currentAmount: newAmount },\n  });\n\n  return { success: true, newAmount };\n}\n\nexport async function setupUserStrategy(\n  userId: string,\n  data: {\n    paycheckBankAccountId?: string;\n    spendingBankAccountId?: string;\n    discretionaryBudgetMonthly?: number;\n    emergencyFundTarget?: number;\n    debtSurplusPercent?: number;\n    savingsSurplusPercent?: number;\n    payoffStartDate?: Date;\n    payoffStartTotalDebt?: number;\n    payoffTargetDate?: Date;\n  }\n): Promise<void> {\n  await prisma.user.update({\n    where: { id: userId },\n    data: {\n      ...(data.paycheckBankAccountId !== undefined && {\n        paycheckBankAccountId: data.paycheckBankAccountId,\n      }),\n      ...(data.spendingBankAccountId !== undefined && {\n        spendingBankAccountId: data.spendingBankAccountId,\n      }),\n      ...(data.discretionaryBudgetMonthly !== undefined && {\n        discretionaryBudgetMonthly: data.discretionaryBudgetMonthly,\n      }),\n      ...(data.emergencyFundTarget !== undefined && {\n        emergencyFundTarget: data.emergencyFundTarget,\n      }),\n      ...(data.debtSurplusPercent !== undefined && {\n        debtSurplusPercent: data.debtSurplusPercent,\n      }),\n      ...(data.savingsSurplusPercent !== undefined && {\n        savingsSurplusPercent: data.savingsSurplusPercent,\n      }),\n      ...(data.payoffStartDate !== undefined && {\n        payoffStartDate: data.payoffStartDate,\n      }),\n      ...(data.payoffStartTotalDebt !== undefined && {\n        payoffStartTotalDebt: data.payoffStartTotalDebt,\n      }),\n      ...(data.payoffTargetDate !== undefined && {\n        payoffTargetDate: data.payoffTargetDate,\n      }),\n    },\n  });\n}\n\nexport async function recalculatePayoffBaseline(\n  userId: string,\n  options: { preserveStartDate?: boolean; preserveTargetDate?: boolean } = {}\n): Promise<{\n  previousStartDebt: number | null;\n  newStartDebt: number;\n  previousStartDate: Date | null;\n  newStartDate: Date;\n}> {\n  const [user, debts] = await Promise.all([\n    prisma.user.findUnique({\n      where: { id: userId },\n      select: {\n        payoffStartDate: true,\n        payoffStartTotalDebt: true,\n        payoffTargetDate: true,\n      },\n    }),\n    prisma.debt.findMany({\n      where: { userId, isActive: true },\n    }),\n  ]);\n\n  const totalDebt = debts.reduce((sum, d) => sum + Number(d.currentBalance), 0);\n  const newStartDate = options.preserveStartDate && user?.payoffStartDate\n    ? user.payoffStartDate\n    : new Date();\n\n  await prisma.user.update({\n    where: { id: userId },\n    data: {\n      payoffStartTotalDebt: totalDebt,\n      payoffStartDate: newStartDate,\n    },\n  });\n\n  return {\n    previousStartDebt: user?.payoffStartTotalDebt ? Number(user.payoffStartTotalDebt) : null,\n    newStartDebt: totalDebt,\n    previousStartDate: user?.payoffStartDate ?? null,\n    newStartDate,\n  };\n}\n\nexport async function getCurrentDebtTotal(userId: string): Promise<number> {\n  const debts = await prisma.debt.findMany({\n    where: { userId, isActive: true },\n  });\n  return debts.reduce((sum, d) => sum + Number(d.currentBalance), 0);\n}\n"],"names":[],"mappings":"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"}