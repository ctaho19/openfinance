{"version":3,"file":"get-session-astro_CVC6HSBT.mjs","sources":["../../../src/lib/get-session-astro.ts"],"sourcesContent":["import { Auth, type AuthConfig } from \"@auth/core\";\nimport type { Session as AuthSession } from \"@auth/core/types\";\nimport { authConfig, getAuthSecret, IDLE_TIMEOUT_SECONDS } from \"./auth-config\";\n\ninterface Session {\n  user?: {\n    id: string;\n    email?: string | null;\n    name?: string | null;\n  };\n  expires: string;\n}\n\nexport async function getSession(request: Request): Promise<Session | null> {\n  const cookieName = process.env.NODE_ENV === \"production\" \n    ? \"__Secure-authjs.session-token\" \n    : \"authjs.session-token\";\n  \n  const cookies = request.headers.get(\"cookie\") || \"\";\n  const sessionToken = cookies\n    .split(\";\")\n    .find(c => c.trim().startsWith(`${cookieName}=`))\n    ?.split(\"=\")[1];\n\n  if (!sessionToken) {\n    return null;\n  }\n\n  try {\n    const sessionUrl = new URL(\"/api/auth/session\", request.url);\n    const sessionRequest = new Request(sessionUrl, {\n      headers: {\n        cookie: request.headers.get(\"cookie\") || \"\",\n      },\n    });\n\n    const config: AuthConfig = {\n      ...authConfig,\n      secret: getAuthSecret(),\n      trustHost: true,\n      basePath: \"/api/auth\",\n      callbacks: {\n        async jwt({ token, user }) {\n          const now = Math.floor(Date.now() / 1000);\n          if (user) {\n            token.id = user.id;\n            token.lastActivity = now;\n            return token;\n          }\n          const lastActivity = (token.lastActivity as number) || now;\n          if (now - lastActivity > IDLE_TIMEOUT_SECONDS) {\n            return {};\n          }\n          token.lastActivity = now;\n          return token;\n        },\n        async session({ session, token }) {\n          if (!token.id) {\n            return {} as AuthSession;\n          }\n          if (session.user && token.id) {\n            (session.user as { id?: string }).id = token.id as string;\n          }\n          return session;\n        },\n      },\n    };\n\n    const response = await Auth(sessionRequest, config);\n    \n    if (!response.ok) {\n      return null;\n    }\n\n    const session = await response.json();\n    \n    if (!session?.user?.id) {\n      return null;\n    }\n\n    return session as Session;\n  } catch (error) {\n    console.error(\"Failed to get session:\", error);\n    return null;\n  }\n}\n\nexport async function requireAuth(request: Request, redirectTo = \"/login\") {\n  const session = await getSession(request);\n  if (!session) {\n    return { redirect: redirectTo, session: null };\n  }\n  return { redirect: null, session };\n}\n"],"names":["session"],"mappings":";;;AAaA,eAAsB,WAAW,OAAA,EAA2C;AAC1E,EAAA,MAAM,UAAA,GAAa,OAAA,CAAQ,GAAA,CAAI,QAAA,KAAa,eACxC,+BAAA,GACA,sBAAA;AAEJ,EAAA,MAAM,OAAA,GAAU,OAAA,CAAQ,OAAA,CAAQ,GAAA,CAAI,QAAQ,CAAA,IAAK,EAAA;AACjD,EAAA,MAAM,eAAe,OAAA,CAClB,KAAA,CAAM,GAAG,CAAA,CACT,IAAA,CAAK,OAAK,CAAA,CAAE,IAAA,GAAO,UAAA,CAAW,CAAA,EAAG,UAAU,CAAA,CAAA,CAAG,CAAC,GAC9C,KAAA,CAAM,GAAG,EAAE,CAAC,CAAA;AAEhB,EAAA,IAAI,CAAC,YAAA,EAAc;AACjB,IAAA,OAAO,IAAA;AAAA,EACT;AAEA,EAAA,IAAI;AACF,IAAA,MAAM,UAAA,GAAa,IAAI,GAAA,CAAI,mBAAA,EAAqB,QAAQ,GAAG,CAAA;AAC3D,IAAA,MAAM,cAAA,GAAiB,IAAI,OAAA,CAAQ,UAAA,EAAY;AAAA,MAC7C,OAAA,EAAS;AAAA,QACP,MAAA,EAAQ,OAAA,CAAQ,OAAA,CAAQ,GAAA,CAAI,QAAQ,CAAA,IAAK;AAAA;AAC3C,KACD,CAAA;AAED,IAAA,MAAM,MAAA,GAAqB;AAAA,MACzB,GAAG,UAAA;AAAA,MACH,QAAQ,aAAA,EAAc;AAAA,MACtB,SAAA,EAAW,IAAA;AAAA,MACX,QAAA,EAAU,WAAA;AAAA,MACV,SAAA,EAAW;AAAA,QACT,MAAM,GAAA,CAAI,EAAE,KAAA,EAAO,MAAK,EAAG;AACzB,UAAA,MAAM,MAAM,IAAA,CAAK,KAAA,CAAM,IAAA,CAAK,GAAA,KAAQ,GAAI,CAAA;AACxC,UAAA,IAAI,IAAA,EAAM;AACR,YAAA,KAAA,CAAM,KAAK,IAAA,CAAK,EAAA;AAChB,YAAA,KAAA,CAAM,YAAA,GAAe,GAAA;AACrB,YAAA,OAAO,KAAA;AAAA,UACT;AACA,UAAA,MAAM,YAAA,GAAgB,MAAM,YAAA,IAA2B,GAAA;AACvD,UAAA,IAAI,GAAA,GAAM,eAAe,oBAAA,EAAsB;AAC7C,YAAA,OAAO,EAAC;AAAA,UACV;AACA,UAAA,KAAA,CAAM,YAAA,GAAe,GAAA;AACrB,UAAA,OAAO,KAAA;AAAA,QACT,CAAA;AAAA,QACA,MAAM,OAAA,CAAQ,EAAE,OAAA,EAAAA,QAAAA,EAAS,OAAM,EAAG;AAChC,UAAA,IAAI,CAAC,MAAM,EAAA,EAAI;AACb,YAAA,OAAO,EAAC;AAAA,UACV;AACA,UAAA,IAAIA,QAAAA,CAAQ,IAAA,IAAQ,KAAA,CAAM,EAAA,EAAI;AAC5B,YAACA,QAAAA,CAAQ,IAAA,CAAyB,EAAA,GAAK,KAAA,CAAM,EAAA;AAAA,UAC/C;AACA,UAAA,OAAOA,QAAAA;AAAA,QACT;AAAA;AACF,KACF;AAEA,IAAA,MAAM,QAAA,GAAW,MAAM,IAAA,CAAK,cAAA,EAAgB,MAAM,CAAA;AAElD,IAAA,IAAI,CAAC,SAAS,EAAA,EAAI;AAChB,MAAA,OAAO,IAAA;AAAA,IACT;AAEA,IAAA,MAAM,OAAA,GAAU,MAAM,QAAA,CAAS,IAAA,EAAK;AAEpC,IAAA,IAAI,CAAC,OAAA,EAAS,IAAA,EAAM,EAAA,EAAI;AACtB,MAAA,OAAO,IAAA;AAAA,IACT;AAEA,IAAA,OAAO,OAAA;AAAA,EACT,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,0BAA0B,KAAK,CAAA;AAC7C,IAAA,OAAO,IAAA;AAAA,EACT;AACF;;;;"}