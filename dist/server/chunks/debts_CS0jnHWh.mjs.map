{"version":3,"file":"debts_CS0jnHWh.mjs","sources":["../../../src/lib/services/debts.ts"],"sourcesContent":["import { prisma } from \"@/lib/db\";\nimport { generatePaymentSchedule, calculateEffectiveAPR } from \"@/lib/bnpl-utils\";\nimport type { Debt, DebtPayment, DebtType, DebtStatus, BillCategory } from \"@prisma/client\";\n\nexport type DebtWithPayments = Debt & {\n  payments: DebtPayment[];\n};\n\nexport interface CreateDebtInput {\n  name: string;\n  type: DebtType;\n  currentBalance: number;\n  originalBalance: number;\n  interestRate: number;\n  minimumPayment: number;\n  dueDay: number;\n  notes?: string | null;\n  numberOfPayments?: number;\n  firstPaymentDate?: string;\n  paymentFrequency?: \"weekly\" | \"biweekly\" | \"monthly\";\n  bankAccountId?: string | null;\n  totalRepayable?: number;\n}\n\nexport interface UpdateDebtInput {\n  name?: string;\n  type?: DebtType;\n  status?: DebtStatus;\n  currentBalance?: number;\n  originalBalance?: number;\n  interestRate?: number;\n  minimumPayment?: number;\n  pastDueAmount?: number | null;\n  dueDay?: number;\n  deferredUntil?: string | null;\n  notes?: string | null;\n  isActive?: boolean;\n  bankAccountId?: string | null;\n  totalRepayable?: number | null;\n  numberOfPayments?: number;\n  firstPaymentDate?: string;\n  paymentFrequency?: \"weekly\" | \"biweekly\" | \"monthly\";\n  regenerateSchedule?: boolean;\n}\n\nexport interface PaymentInput {\n  amount: number;\n  date: string;\n  notes?: string | null;\n}\n\nconst debtTypeToBillCategory: Record<DebtType, BillCategory> = {\n  CREDIT_CARD: \"CREDIT_CARD\",\n  AUTO_LOAN: \"LOAN\",\n  STUDENT_LOAN: \"LOAN\",\n  PERSONAL_LOAN: \"LOAN\",\n  BNPL: \"BNPL\",\n  MORTGAGE: \"LOAN\",\n  OTHER: \"OTHER\",\n};\n\nexport async function listDebts(userId: string, sortBy: string = \"effective\"): Promise<Debt[]> {\n  let orderBy: Record<string, \"asc\" | \"desc\">;\n  switch (sortBy) {\n    case \"apr\":\n      orderBy = { interestRate: \"desc\" };\n      break;\n    case \"balance\":\n      orderBy = { currentBalance: \"desc\" };\n      break;\n    case \"effective\":\n    default:\n      orderBy = { interestRate: \"desc\" };\n      break;\n  }\n\n  const debts = await prisma.debt.findMany({\n    where: { userId, isActive: true },\n    orderBy,\n  });\n\n  if (sortBy === \"effective\") {\n    debts.sort((a, b) => {\n      const aRate = Math.max(\n        Number(a.effectiveRate) || 0,\n        Number(a.interestRate) || 0\n      );\n      const bRate = Math.max(\n        Number(b.effectiveRate) || 0,\n        Number(b.interestRate) || 0\n      );\n      return bRate - aRate;\n    });\n  }\n\n  return debts;\n}\n\nexport interface SerializedDebt {\n  id: string;\n  userId: string;\n  name: string;\n  type: string;\n  status: string;\n  currentBalance: number;\n  originalBalance: number;\n  interestRate: number;\n  effectiveRate: number | null;\n  totalRepayable: number | null;\n  minimumPayment: number;\n  pastDueAmount: number | null;\n  dueDay: number;\n  startDate: string;\n  deferredUntil: string | null;\n  bankAccountId: string | null;\n  isActive: boolean;\n  notes: string | null;\n  createdAt: string;\n  updatedAt: string;\n  payments: Array<{\n    id: string;\n    debtId: string;\n    date: string;\n    amount: number;\n    principal: number;\n    interest: number;\n    newBalance: number;\n    notes: string | null;\n    createdAt: string;\n  }>;\n}\n\nfunction serializeDebt(debt: DebtWithPayments): SerializedDebt {\n  return {\n    id: debt.id,\n    userId: debt.userId,\n    name: debt.name,\n    type: debt.type,\n    status: debt.status,\n    currentBalance: Number(debt.currentBalance),\n    originalBalance: Number(debt.originalBalance),\n    interestRate: Number(debt.interestRate),\n    effectiveRate: debt.effectiveRate ? Number(debt.effectiveRate) : null,\n    totalRepayable: debt.totalRepayable ? Number(debt.totalRepayable) : null,\n    minimumPayment: Number(debt.minimumPayment),\n    pastDueAmount: debt.pastDueAmount ? Number(debt.pastDueAmount) : null,\n    dueDay: debt.dueDay,\n    startDate: debt.startDate.toISOString(),\n    deferredUntil: debt.deferredUntil ? debt.deferredUntil.toISOString() : null,\n    bankAccountId: debt.bankAccountId,\n    isActive: debt.isActive,\n    notes: debt.notes,\n    createdAt: debt.createdAt.toISOString(),\n    updatedAt: debt.updatedAt.toISOString(),\n    payments: debt.payments.map((p) => ({\n      id: p.id,\n      debtId: p.debtId,\n      date: p.date.toISOString(),\n      amount: Number(p.amount),\n      principal: Number(p.principal),\n      interest: Number(p.interest),\n      newBalance: Number(p.newBalance),\n      notes: p.notes,\n      createdAt: p.createdAt.toISOString(),\n    })),\n  };\n}\n\nexport async function getDebt(userId: string, debtId: string): Promise<SerializedDebt | null> {\n  const debt = await prisma.debt.findFirst({\n    where: { id: debtId, userId },\n    include: {\n      payments: {\n        orderBy: { date: \"desc\" },\n      },\n    },\n  });\n\n  if (!debt) {\n    return null;\n  }\n\n  return serializeDebt(debt);\n}\n\nexport async function createDebt(userId: string, data: CreateDebtInput): Promise<Debt> {\n  const existingDebt = await prisma.debt.findFirst({\n    where: { userId, name: data.name },\n    select: { id: true },\n  });\n  if (existingDebt) {\n    throw new Error(`A debt named \"${data.name}\" already exists`);\n  }\n\n  if (data.bankAccountId) {\n    const bankAccount = await prisma.bankAccount.findFirst({\n      where: { id: data.bankAccountId, userId },\n      select: { id: true },\n    });\n    if (!bankAccount) {\n      throw new Error(\"Invalid bank account reference\");\n    }\n  }\n\n  const isBNPL = data.type === \"BNPL\";\n\n  if (isBNPL && (!data.numberOfPayments || !data.firstPaymentDate || !data.paymentFrequency)) {\n    throw new Error(\"BNPL debts require numberOfPayments, firstPaymentDate, and paymentFrequency\");\n  }\n\n  let effectiveRate = null;\n  if (isBNPL && data.totalRepayable && data.totalRepayable !== data.currentBalance) {\n    effectiveRate = calculateEffectiveAPR({\n      principal: data.currentBalance,\n      totalRepayable: data.totalRepayable,\n      numberOfPayments: data.numberOfPayments!,\n      frequency: data.paymentFrequency!,\n    });\n  }\n\n  const debt = await prisma.debt.create({\n    data: {\n      userId,\n      name: data.name,\n      type: data.type,\n      currentBalance: data.currentBalance,\n      originalBalance: data.originalBalance,\n      interestRate: data.interestRate,\n      effectiveRate,\n      totalRepayable: data.totalRepayable || null,\n      minimumPayment: data.minimumPayment,\n      dueDay: data.dueDay,\n      notes: data.notes || null,\n      bankAccountId: data.bankAccountId || null,\n    },\n  });\n\n  if (!isBNPL) {\n    await prisma.bill.create({\n      data: {\n        userId,\n        name: `${data.name} Payment`,\n        category: debtTypeToBillCategory[data.type],\n        amount: data.minimumPayment,\n        dueDay: data.dueDay,\n        isRecurring: true,\n        frequency: \"MONTHLY\",\n        debtId: debt.id,\n        bankAccountId: data.bankAccountId || null,\n        notes: `Auto-generated bill for ${data.name}`,\n      },\n    });\n  }\n\n  if (isBNPL) {\n    const schedule = generatePaymentSchedule({\n      totalAmount: data.currentBalance,\n      numberOfPayments: data.numberOfPayments!,\n      firstPaymentDate: new Date(data.firstPaymentDate + \"T00:00:00\"),\n      frequency: data.paymentFrequency!,\n    });\n\n    for (let i = 0; i < schedule.paymentDates.length; i++) {\n      const paymentDate = schedule.paymentDates[i];\n\n      await prisma.scheduledPayment.create({\n        data: {\n          debtId: debt.id,\n          dueDate: paymentDate,\n          amount: schedule.paymentAmount,\n          notes: `Payment ${i + 1} of ${data.numberOfPayments}`,\n        },\n      });\n    }\n\n    for (let i = 0; i < schedule.paymentDates.length; i++) {\n      const paymentDate = schedule.paymentDates[i];\n      const paymentNumber = i + 1;\n\n      const bill = await prisma.bill.create({\n        data: {\n          userId,\n          name: `${data.name} - Payment ${paymentNumber} of ${data.numberOfPayments}`,\n          category: \"BNPL\",\n          amount: schedule.paymentAmount,\n          dueDay: paymentDate.getDate(),\n          isRecurring: false,\n          frequency: \"ONCE\",\n          debtId: debt.id,\n          bankAccountId: data.bankAccountId || null,\n          notes: `Auto-generated BNPL payment for ${data.name}`,\n        },\n      });\n\n      await prisma.billPayment.create({\n        data: {\n          billId: bill.id,\n          dueDate: paymentDate,\n          amount: schedule.paymentAmount,\n          status: \"UNPAID\",\n        },\n      });\n    }\n  }\n\n  return debt;\n}\n\nexport async function updateDebt(\n  userId: string,\n  debtId: string,\n  data: UpdateDebtInput\n): Promise<Debt> {\n  const existing = await prisma.debt.findFirst({\n    where: { id: debtId, userId },\n  });\n\n  if (!existing) {\n    throw new Error(\"Debt not found\");\n  }\n\n  let effectiveRate = undefined;\n  const isBNPL = (data.type || existing.type) === \"BNPL\";\n  const balance = data.currentBalance !== undefined ? data.currentBalance : Number(existing.currentBalance);\n\n  if (isBNPL && data.totalRepayable !== undefined) {\n    if (data.totalRepayable && data.totalRepayable !== balance && data.numberOfPayments && data.paymentFrequency) {\n      effectiveRate = calculateEffectiveAPR({\n        principal: balance,\n        totalRepayable: data.totalRepayable,\n        numberOfPayments: data.numberOfPayments,\n        frequency: data.paymentFrequency,\n      });\n    } else {\n      effectiveRate = null;\n    }\n  }\n\n  const debt = await prisma.debt.update({\n    where: { id: debtId },\n    data: {\n      ...(data.name !== undefined && { name: data.name }),\n      ...(data.type !== undefined && { type: data.type }),\n      ...(data.status !== undefined && { status: data.status }),\n      ...(data.currentBalance !== undefined && { currentBalance: data.currentBalance }),\n      ...(data.originalBalance !== undefined && { originalBalance: data.originalBalance }),\n      ...(data.interestRate !== undefined && { interestRate: data.interestRate }),\n      ...(effectiveRate !== undefined && { effectiveRate }),\n      ...(data.totalRepayable !== undefined && { totalRepayable: data.totalRepayable || null }),\n      ...(data.minimumPayment !== undefined && { minimumPayment: data.minimumPayment }),\n      ...(data.pastDueAmount !== undefined && { pastDueAmount: data.pastDueAmount || null }),\n      ...(data.dueDay !== undefined && { dueDay: data.dueDay }),\n      ...(data.deferredUntil !== undefined && { deferredUntil: data.deferredUntil ? new Date(data.deferredUntil) : null }),\n      ...(data.notes !== undefined && { notes: data.notes }),\n      ...(data.isActive !== undefined && { isActive: data.isActive }),\n      ...(data.bankAccountId !== undefined && { bankAccountId: data.bankAccountId || null }),\n    },\n  });\n\n  if (isBNPL && data.regenerateSchedule && data.numberOfPayments && data.firstPaymentDate && data.paymentFrequency) {\n    const totalAmount = data.totalRepayable || balance;\n    const schedule = generatePaymentSchedule({\n      totalAmount,\n      numberOfPayments: data.numberOfPayments,\n      firstPaymentDate: new Date(data.firstPaymentDate + \"T00:00:00\"),\n      frequency: data.paymentFrequency,\n    });\n\n    await prisma.scheduledPayment.deleteMany({\n      where: { debtId, isPaid: false },\n    });\n\n    const existingBills = await prisma.bill.findMany({\n      where: { debtId },\n      include: { payments: { where: { status: \"UNPAID\" } } },\n    });\n\n    for (const bill of existingBills) {\n      if (bill.payments.length > 0) {\n        await prisma.billPayment.deleteMany({\n          where: { billId: bill.id, status: \"UNPAID\" },\n        });\n        const remainingPayments = await prisma.billPayment.count({\n          where: { billId: bill.id },\n        });\n        if (remainingPayments === 0) {\n          await prisma.bill.delete({ where: { id: bill.id } });\n        }\n      }\n    }\n\n    const debtName = data.name || existing.name;\n    const debtBankAccountId = data.bankAccountId !== undefined ? data.bankAccountId : existing.bankAccountId;\n\n    for (let i = 0; i < schedule.paymentDates.length; i++) {\n      const paymentDate = schedule.paymentDates[i];\n      const paymentNumber = i + 1;\n\n      await prisma.scheduledPayment.create({\n        data: {\n          debtId,\n          dueDate: paymentDate,\n          amount: schedule.paymentAmount,\n          notes: `Payment ${paymentNumber} of ${data.numberOfPayments}`,\n        },\n      });\n\n      const bill = await prisma.bill.create({\n        data: {\n          userId,\n          name: `${debtName} - Payment ${paymentNumber} of ${data.numberOfPayments}`,\n          category: \"BNPL\",\n          amount: schedule.paymentAmount,\n          dueDay: paymentDate.getDate(),\n          isRecurring: false,\n          frequency: \"ONCE\",\n          debtId,\n          bankAccountId: debtBankAccountId || null,\n          notes: `Auto-generated BNPL payment for ${debtName}`,\n        },\n      });\n\n      await prisma.billPayment.create({\n        data: {\n          billId: bill.id,\n          dueDate: paymentDate,\n          amount: schedule.paymentAmount,\n          status: \"UNPAID\",\n        },\n      });\n    }\n\n    await prisma.debt.update({\n      where: { id: debtId },\n      data: { minimumPayment: schedule.paymentAmount },\n    });\n  }\n\n  return debt;\n}\n\nexport async function recordPayment(\n  userId: string,\n  debtId: string,\n  data: PaymentInput\n): Promise<DebtPayment> {\n  const debt = await prisma.debt.findFirst({\n    where: { id: debtId, userId },\n  });\n\n  if (!debt) {\n    throw new Error(\"Debt not found\");\n  }\n\n  const paymentAmount = data.amount;\n  const currentBalance = Number(debt.currentBalance);\n  const interestRate = Number(debt.interestRate);\n\n  const monthlyRate = interestRate / 100 / 12;\n  const interestPortion = currentBalance * monthlyRate;\n  const principalPortion = Math.max(0, paymentAmount - interestPortion);\n  const newBalance = Math.max(0, currentBalance - principalPortion);\n\n  const [payment] = await prisma.$transaction([\n    prisma.debtPayment.create({\n      data: {\n        debtId,\n        date: new Date(data.date),\n        amount: paymentAmount,\n        principal: principalPortion,\n        interest: Math.min(interestPortion, paymentAmount),\n        newBalance,\n        notes: data.notes || null,\n      },\n    }),\n    prisma.debt.update({\n      where: { id: debtId },\n      data: { currentBalance: newBalance },\n    }),\n  ]);\n\n  return payment;\n}\n"],"names":[],"mappings":"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"}