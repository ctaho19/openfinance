{"version":3,"file":"auth-config_mz_UKjvQ.mjs","sources":["../../../src/lib/db.ts","../../../src/lib/auth-config.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: process.env.NODE_ENV === \"development\" ? [\"error\", \"warn\"] : [\"error\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n","import type { Adapter } from \"@auth/core/adapters\";\nimport type { Provider } from \"@auth/core/providers\";\nimport Credentials from \"@auth/core/providers/credentials\";\nimport { PrismaAdapter } from \"@auth/prisma-adapter\";\nimport bcrypt from \"bcryptjs\";\nimport { prisma } from \"./db\";\n\nexport const MAX_SESSION_AGE_SECONDS = 60 * 60 * 8; // 8 hours absolute max\nexport const IDLE_TIMEOUT_SECONDS = 60 * 30; // 30 minutes idle timeout\n\nconst RATE_LIMIT_WINDOW_MS = 15 * 60 * 1000; // 15 minutes\nconst MAX_LOGIN_ATTEMPTS = 5;\n\nconst loginAttempts = new Map<string, { count: number; firstAttempt: number }>();\n\nfunction checkRateLimit(email: string): boolean {\n  const key = email.toLowerCase();\n  const now = Date.now();\n  const record = loginAttempts.get(key);\n\n  if (!record) return false;\n\n  if (now - record.firstAttempt > RATE_LIMIT_WINDOW_MS) {\n    loginAttempts.delete(key);\n    return false;\n  }\n\n  return record.count >= MAX_LOGIN_ATTEMPTS;\n}\n\nfunction recordFailedAttempt(email: string): void {\n  const key = email.toLowerCase();\n  const now = Date.now();\n  const record = loginAttempts.get(key);\n\n  if (!record || now - record.firstAttempt > RATE_LIMIT_WINDOW_MS) {\n    loginAttempts.set(key, { count: 1, firstAttempt: now });\n  } else {\n    record.count++;\n  }\n}\n\nfunction resetAttempts(email: string): void {\n  loginAttempts.delete(email.toLowerCase());\n}\n\nexport function getAuthSecret() {\n  if (process.env.AUTH_SECRET) {\n    return process.env.AUTH_SECRET;\n  }\n\n  try {\n    // eslint-disable-next-line @typescript-eslint/no-require-imports\n    const { Resource } = require(\"sst\");\n    if (Resource.AuthSecret?.value) return Resource.AuthSecret.value;\n  } catch {\n    // SST not available\n  }\n\n  throw new Error(\"AUTH_SECRET is not set\");\n}\n\nexport const adapter: Adapter = PrismaAdapter(prisma);\n\nexport const providers: Provider[] = [\n  Credentials({\n    name: \"credentials\",\n    credentials: {\n      email: { label: \"Email\", type: \"email\" },\n      password: { label: \"Password\", type: \"password\" },\n    },\n    async authorize(credentials) {\n      if (!credentials?.email || !credentials?.password) {\n        return null;\n      }\n\n      const email = (credentials.email as string).toLowerCase().trim();\n\n      if (checkRateLimit(email)) {\n        console.warn(\"auth_rate_limited\", { email });\n        return null;\n      }\n\n      const user = await prisma.user.findUnique({\n        where: { email },\n      });\n\n      if (!user || !user.password) {\n        recordFailedAttempt(email);\n        return null;\n      }\n\n      const isValid = await bcrypt.compare(\n        credentials.password as string,\n        user.password\n      );\n\n      if (!isValid) {\n        recordFailedAttempt(email);\n        console.warn(\"auth_failed_login\", { email });\n        return null;\n      }\n\n      resetAttempts(email);\n      console.info(\"auth_sign_in\", { userId: user.id, email });\n\n      return {\n        id: user.id,\n        email: user.email,\n        name: user.name,\n      };\n    },\n  }),\n];\n\nexport const sessionConfig = {\n  strategy: \"jwt\" as const,\n  maxAge: MAX_SESSION_AGE_SECONDS,\n};\n\nexport const cookieConfig = {\n  sessionToken: {\n    name:\n      process.env.NODE_ENV === \"production\"\n        ? \"__Secure-authjs.session-token\"\n        : \"authjs.session-token\",\n    options: {\n      httpOnly: true,\n      sameSite: \"strict\" as const,\n      secure: process.env.NODE_ENV === \"production\",\n      path: \"/\",\n    },\n  },\n};\n\nexport const pagesConfig = {\n  signIn: \"/login\",\n};\n\nexport const eventsConfig = {\n  async signOut(message: { token: { sub?: string } | null } | { session: unknown }) {\n    const tokenId =\n      \"token\" in message ? (message.token?.sub ?? \"unknown\") : \"session\";\n    console.info(\"auth_sign_out\", { tokenId });\n  },\n};\n\nexport function handleJwtCallback(token: Record<string, unknown>, user?: { id?: string }) {\n  const now = Math.floor(Date.now() / 1000);\n\n  if (user) {\n    token.id = user.id;\n    token.lastActivity = now;\n    return token;\n  }\n\n  const lastActivity = (token.lastActivity as number) || now;\n  if (now - lastActivity > IDLE_TIMEOUT_SECONDS) {\n    console.info(\"auth_idle_timeout\", { userId: token.id });\n    return {};\n  }\n\n  token.lastActivity = now;\n  return token;\n}\n\nexport function handleSessionCallback<T extends { user?: { id?: string } }>(\n  session: T,\n  token: Record<string, unknown>\n): T | null {\n  if (!token.id) {\n    return null;\n  }\n  if (session.user && token.id) {\n    session.user.id = token.id as string;\n  }\n  return session;\n}\n\nexport const authConfig = {\n  adapter,\n  providers,\n  session: sessionConfig,\n  cookies: cookieConfig,\n  pages: pagesConfig,\n  events: eventsConfig,\n};\n"],"names":[],"mappings":"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"}