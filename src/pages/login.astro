---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getSession } from '../lib/get-session-astro';

// Redirect if already logged in
const session = await getSession(Astro.request);
if (session?.user?.id) {
  return Astro.redirect('/dashboard');
}

// Check for error in URL
const error = Astro.url.searchParams.get('error');
---
<BaseLayout title="Login">
  <div class="min-h-screen bg-theme-secondary flex items-center justify-center px-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <div class="w-16 h-16 rounded-2xl bg-chase-gradient flex items-center justify-center mx-auto mb-4 shadow-lg">
          <span class="text-white font-bold text-2xl">OF</span>
        </div>
        <h1 class="text-2xl font-bold text-theme-primary">Welcome to OpenFinance</h1>
        <p class="text-theme-secondary mt-2">Sign in to manage your finances</p>
      </div>
      
      <div class="bg-theme-elevated rounded-2xl border border-theme shadow-theme p-6">
        <div id="error-message" class="hidden mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-sm">
        </div>
        
        {error && (
          <div class="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-sm">
            {error === 'CredentialsSignin' ? 'Invalid email or password' : 'An error occurred. Please try again.'}
          </div>
        )}
        
        <form id="login-form" class="space-y-4">
          <div>
            <label for="email" class="block text-sm font-medium text-theme-primary mb-1.5">
              Email
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-2.5 rounded-xl border border-theme bg-theme-primary text-theme-primary placeholder:text-theme-muted focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-transparent transition-colors"
              placeholder="you@example.com"
            />
          </div>
          <div>
            <label for="password" class="block text-sm font-medium text-theme-primary mb-1.5">
              Password
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              class="w-full px-4 py-2.5 rounded-xl border border-theme bg-theme-primary text-theme-primary placeholder:text-theme-muted focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-transparent transition-colors"
              placeholder="••••••••"
            />
          </div>
          <button
            type="submit"
            id="submit-btn"
            class="w-full py-3 bg-accent-600 hover:bg-accent-700 text-white rounded-xl font-semibold transition-colors disabled:opacity-50"
          >
            Sign In
          </button>
        </form>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  const form = document.getElementById('login-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const errorDiv = document.getElementById('error-message') as HTMLDivElement;
  
  function showError(message: string) {
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
  }
  
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Signing in...';
    errorDiv.classList.add('hidden');
    
    try {
      // First, get CSRF token
      const csrfRes = await fetch('/api/auth/csrf');
      const { csrfToken } = await csrfRes.json();
      
      const formData = new FormData(form);
      formData.append('csrfToken', csrfToken);
      
      // Submit to credentials callback
      const res = await fetch('/api/auth/callback/credentials', {
        method: 'POST',
        body: new URLSearchParams(formData as unknown as Record<string, string>),
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        credentials: 'include',
      });
      
      // Check if the response indicates an error
      const url = new URL(res.url);
      if (url.searchParams.has('error')) {
        const error = url.searchParams.get('error');
        if (error === 'CredentialsSignin') {
          showError('Invalid email or password');
        } else {
          showError('An error occurred. Please try again.');
        }
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign In';
        return;
      }
      
      // Success - redirect to dashboard
      window.location.href = '/dashboard';
    } catch (err) {
      console.error('Login error:', err);
      showError('An error occurred. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Sign In';
    }
  });
</script>
